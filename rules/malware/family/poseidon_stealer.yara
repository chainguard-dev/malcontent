import "math"

private rule macho {
  strings:
    $not_jar = "META-INF/"
    $not_dwarf = "_DWARF"
    $not_kext = "_.SYMDEF SORTED"
  condition:
    (uint32(0) == 4277009102 or uint32(0) == 3472551422 or uint32(0) == 4277009103 or uint32(0) == 3489328638 or uint32(0) == 3405691582 or uint32(0) == 3199925962 or uint32(0) == 3405691583 or uint32(0) == 3216703178) and none of ($not*)
}

rule poseidon : high macos { 
  meta:
    description = "Possible Poseidon infostealer"
	ref = "https://www.intego.com/mac-security-blog/poseidon-macos-malware-employs-new-tricks-targets-swiss-mac-users/"
	filetypes = "macho"
  strings:
	$le = "cEEE8max_sizeB8ue170006IS2_vEEmRKS2_" fullword
	$sy = "@_system" fullword
	$sy2 = "_system" fullword
	$bs = "basic_string" fullword
	$ve = "vector" fullword
  condition:
	filesize > 190KB and filesize < 400KB and macho and all of them and math.entropy(20000,50000) >= 2.5
}

rule poseidon_url : high macos { 
  meta:
    description = "Poseidon Infostealer"
	ref = "https://www.intego.com/mac-security-blog/poseidon-macos-malware-employs-new-tricks-targets-swiss-mac-users/"
	filetypes = "macho"
  strings:
	$ref = "https://forked-project.com/check_updates"
  condition:
	filesize > 190KB and filesize < 400KB and macho and all of them
}
