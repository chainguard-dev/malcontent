import "math"

private rule amos_macho {
  strings:
    $not_jar   = "META-INF/"
    $not_dwarf = "_DWARF"
    $not_kext  = "_.SYMDEF SORTED"

  condition:
    (uint32(0) == 4277009102 or uint32(0) == 3472551422 or uint32(0) == 4277009103 or uint32(0) == 3489328638 or uint32(0) == 3405691582 or uint32(0) == 3199925962 or uint32(0) == 3405691583 or uint32(0) == 3216703178) and none of ($not*)
}

rule amos_magic_var: critical macos {
  meta:
    description = "AMOS infostealer variant"
    ref         = "https://www.intego.com/mac-security-blog/poseidon-macos-malware-employs-new-tricks-targets-swiss-mac-users/"
    filetypes   = "macho"
    hash        = "6427baa1ce5ba37ff6cf3fff79b543018a0a8e8f088c3f66afb24561e4e9de43"

  strings:
    $magic            = "_MAGIC_VAR_"
    $header           = "mh_execute_header"
    $main             = "main" fullword
    $f_system         = "@_system"
    $f_setsid         = "@_setsid"
    $f_fork           = "@_fork"
    $word_with_spaces = /[a-z]{2,} [a-z]{2,}/

  condition:
    filesize > 100KB and filesize < 600KB and amos_macho and $magic and $header and $main and all of ($f*) and #word_with_spaces < 3
}

rule amos_base32: critical macos {
  meta:
    description = "AMOS infostealer"
    ref         = "https://www.intego.com/mac-security-blog/poseidon-macos-malware-employs-new-tricks-targets-swiss-mac-users/"
    filetypes   = "macho"

  strings:
    $base32   = "Invalid Base32 character"
    $header   = "mh_execute_header"
    $f_system = "@_system"
    $charset  = "ABCDEFGHIJKLMNOPQRSTUVWXYZ234567"
    $at_exit  = "@___cxa_atexit"

  condition:
    filesize > 40KB and filesize < 2MB and amos_macho and all of them
}

rule maybe_amos: high macos {
  meta:
    description = "Possible AMOS-like infostealer"
    filetypes   = "macho"

  strings:
    $le  = "@__ZTISt12length_error" fullword
    $zd  = "@__ZdlPv" fullword
    $zn  = "@__Znwm" fullword
    $sy  = "@_system" fullword
    $sy2 = "_system" fullword
    $bs  = "basic_string" fullword
    $ve  = "vector" fullword

    $not_fs      = "@_FSFindFolder" fullword
    $not_gestalt = "@_Gestalt" fullword
    $not_release = "@_CFRelease" fullword

  condition:
    filesize > 190KB and filesize < 400KB and amos_macho and all of them and none of ($not*) and math.entropy(1, filesize) >= 4
}

rule maybe_amos_hex: high macos {
  meta:
    description = "Possible AMOS-like infostealer (hex obfuscated)"
    filetypes   = "macho"

  strings:
    $f_zd     = "@__ZdlPv" fullword
    $f_sy     = "@_system" fullword
    $f_main   = "_main" fullword
    $f_labs   = "@_labs" fullword
    $f_memcpy = "@_memcpy" fullword
    $f_signal = "@_signal" fullword
    $f_fork   = "@_fork" fullword
    $f_exit   = "@_exit" fullword
    $f_setsid = "@_setsid" fullword
    $f_memset = "@_memset" fullword
    $f_strlen = "@_strlen" fullword
    $f_unwind = "@__Unwind_Resume" fullword
    $x        = /0x[\dabcdefABCDEF]{2,8}/

  condition:
    filesize > 190KB and filesize < 400KB and amos_macho and 95 % of ($f*) and math.entropy(20000, 50000) >= 4.5 and #x > 64
}
